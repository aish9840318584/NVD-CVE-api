import requests
import mysql.connector
import datetime


def fetch_cve_data():
    url = 'https://services.nvd.nist.gov/rest/json/cves/2.0'
    response = requests.get(url)
    if response.status_code == 200:
        return response.json()
    else:
        print("Failed to fetch data from CVE API")
        return None


def store_data_in_mysql(data):
    try:
        connection = mysql.connector.connect(
            host='localhost',
            user='root',
            password='Dhanun@01',
            database='cve_database'
        )

        cursor = connection.cursor()

       
        for entry in data['vulnerabilities']:
            cve_id = entry['cve']['id']
            source_identifier = entry['cve'].get('sourceIdentifier', '')
            published_date = entry['cve'].get('published', '')
            last_modified_date = entry['cve'].get('lastModified', '')
            status = entry['cve'].get('vulnStatus', '')

            insert_query = "INSERT INTO vulnerabilities (cve_id, identifier, published_date, last_modified_date, vul_status) VALUES (%s, %s, %s, %s, %s)"
            cursor.execute(insert_query, (cve_id, source_identifier, published_date, last_modified_date, status))

        connection.commit()
        print("Data successfully stored in MySQL database")

    except mysql.connector.Error as error:
        print("Failed to store data in MySQL database:", error)

    finally:
        if connection.is_connected():
            cursor.close()
            connection.close()


def display_vulnerabilities(page_number, results_per_page):

    try:
        # Connect to MySQL database
        connection = mysql.connector.connect(
            host='localhost',
            user='root',
            password='Dhanun@01',
            database='cve_database'
        )

        cursor = connection.cursor()

        
        count_query = "SELECT COUNT(*) FROM vulnerabilities"
        cursor.execute(count_query)
        total_records = cursor.fetchone()[0]

        
        offset = (page_number - 1) * results_per_page

        
        select_query = f"SELECT cve_id, identifier, published_date, last_modified_date, vul_status FROM vulnerabilities LIMIT {results_per_page} OFFSET {offset}"
        cursor.execute(select_query)

        
        rows = cursor.fetchall()

        
        data = []
        for row in rows:
            cve_id, identifier, published_date, last_modified_date, vul_status = row
            # Convert datetime.date objects to strings
            published_date = published_date.strftime('%Y-%m-%d') if published_date else ''
            last_modified_date = last_modified_date.strftime('%Y-%m-%d') if last_modified_date else ''
            # Format dates
            published_date = datetime.datetime.strptime(published_date, '%Y-%m-%d').strftime('%d %b %Y')
            last_modified_date = datetime.datetime.strptime(last_modified_date, '%Y-%m-%d').strftime('%d %b %Y')
            data.append({
                'cve_id': cve_id,
                'identifier': identifier,
                'published_date': published_date,
                'last_modified_date': last_modified_date,
                'vul_status': vul_status
            })

        return data, total_records

    except mysql.connector.Error as error:
        print("Failed to fetch data from MySQL database:", error)

    finally:
        if connection.is_connected():
            cursor.close()
            connection.close()
def main():
    cve_data = fetch_cve_data()
    if cve_data:
        store_data_in_mysql(cve_data)

if __name__ == "__main__":
    main()
